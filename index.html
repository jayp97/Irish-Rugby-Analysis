<html>
<head>
    <meta charset="utf-8">
    <title>How has Ireland Changed? A data driven Visual Essay</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
    <script src="simple_statistics.js"></script>

    <script src="https://d3js.org/d3-color.v2.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v2.min.js"></script>
    
    <link rel="stylesheet" href="/styles/style.css">

</head>
<body>
    <div class="main-content">
        <h1 class="title"><i>A History of Irish Rugby</i> <br>Count(y)ing the Players </h1>
        <div class="spacer-1"></div>
        <p>Having read <a href="https://nba-origins.herokuapp.com">"Where are NBA Players from?"</a> by Sam Learner, a great interactive map that displays the history of the NBA with respect to its players (you should totally check it out), I was inspired to do a similar thing for Irish Rugby.</p>
        <p>The map to the right plots the home counties of all Irish Rugby players who have ever existed by place of birth. Use the toggle and buttons below to change the 5-year period and the specific player metrics.</p>
        <div id="sliderContainer">
            <input id="timeslide" type="range" min="0" max="28" value="28" step="1"/><br>
            <span id="range">2015-2020</span>
        </div>
        <div class="button-group-1">
            <button id="player-debut" type="button" value="Player Debut" title="Only include players who debuted in the selected time period">
                Player Debut
             </button>
             <button id="all-time" type="button" value="All Time" title="Include all players who debuted on or before the selected time period">
                 All Time
             </button>
        </div>
        
    </div>
        <h2 class="name"></h2>
        <h2 class="total-players"></h2>
  <script>
        
    // var width = window.innerWidth,
    //     height = window.innerHeight;
    // rangeValue = null;
    rangeValue = [2015,2020]; 
    period = [[1875,1880], [1880,1885],[1885,1890], [1890,1895], [1895,1900], [1900,1905], [1905,1910], [1910,1915], [1915,1920], [1920,1925], [1925,1930], [1930,1935], [1935,1940], [1940,1945], [1945,1950], [1950,1955], [1955,1960], [1960,1965], [1965,1970], [1970,1975], [1975,1980], [1980,1985], [1985,1990], [1990,1995], [1995,2000], [2000,2005], [2005,2010], [2010,2015], [2015,2020]] ;

    buttonSetOne = "All Time"

    divisions = null

    var width = 650,
        height = 810;
    
    var svg = d3.select( "body" )
          .append( "svg" )
          .attr( "width", width )
          .attr( "height", height );
      
    var projection = d3.geo.albers()
        .center([0, 53.4])
        .rotate([8.1, 0])
        .parallels([50, 60])
        .scale(11000)
        .translate([width / 2, height / 2]);

    var geoPath = d3.geo.path()
        .projection(projection);


        // d3.csv("irish-counties-population.csv", function(data) {
    data = d3.json("final-data/irish-player-data.json", function(data) {
        // console.log(data[0][1000]["birth_place"]["county"]);

        queue()
            .defer(d3.json, "counties-topo.json")
            .await(ready);

            function ready(error, counties) {


                let breaks = ss.jenks(counties.objects.counties.geometries.map(function(d) {
                                // return whatPopulation(d.properties.NAME_TAG) / d.properties.AREA; 
                                // return whatCounty(d.properties.NAME_TAG)/1;
                                // console.log("inside breaks "+divs)
                                return playerCount(d.properties.NAME_TAG, rangeValue)/1;
                            }), 9);

                breaks.shift(); // remove min value from breaks Array before applying to domain
                breaks.pop(); // same for max

                let colors = d3.schemeYlGn[9];

                let jenks = d3.scale.threshold()
                    .domain(breaks)
                    .range(colors);

                // Jenkers function should only be used for player debut button. 
                function jenkers(divs){

                    breakers = ss.jenks(counties.objects.counties.geometries.map(function(d) {
                        // return whatPopulation(d.properties.NAME_TAG) / d.properties.AREA; 
                        // return whatCounty(d.properties.NAME_TAG)/1;
                        console.log("inside breaks "+divs)
                        return playerCount(d.properties.NAME_TAG, rangeValue)/1;
                    }), divs);
   
                    breakers.shift(); // remove min value from breaks Array before applying to domain
                    breakers.pop(); // same for max
                    
                    let colors = d3.schemeYlGn[divs];

                    return d3.scale.threshold()
                        .domain(breakers)
                        .range(colors);
                }

            function playerCount(county, range) {
                let counter = 0
                var dataCount = Object.keys(data[0]).length
                // console.log(divisions)
                for (var i = 1; i < dataCount+1; i++) {

                    if (buttonSetOne == "Player Debut")
                        if (county == data[0][i]["birth_place"]["county"] && data[0][i]["debut year"] > range[0] && data[0][i]["debut year"] <= range[1])
                            // counter = counter + parseInt(data[0][i]["statistics"]["tries"]); 
                            counter++;  

                        if (range[0]==1875 && county == data[0][i]["birth_place"]["county"] && data[0][i]["debut year"]==1875)
                            // counter = counter + parseInt(data[0][i]["statistics"]["tries"]); 
                            counter++;   
                    else if (buttonSetOne == "All Time")
                        if (county == data[0][i]["birth_place"]["county"] && data[0][i]["debut year"] >= period[0][0] && data[0][i]["debut year"] <= range[1])
                            // counter = counter + parseInt(data[0][i]["statistics"]["tries"]); 
                            counter++;  

                }
                // console.log(counter)
                // return counter;
                return +Math.log2(counter+1);
            }


            svg.append("g")
                .selectAll("path")
                .data(topojson.feature(counties, counties.objects.counties).features)
                .enter()
                .append("path")
                .attr("d", geoPath)
                .attr("class", "county")
                .attr("fill", function(d) {
                    // return jenks(whatCounty(d.properties.NAME_TAG)/1);
                    console.log(playerCount(d.properties.NAME_TAG, rangeValue)/1)
                    return jenks(playerCount(d.properties.NAME_TAG, rangeValue)/1);
                })
                .on("mouseover", function(d) {
                    d3.select("body").select(".name").text('County: ' + d.properties.NAME_TAG);
                    d3.select("body").select(".total-players").text("Total Players: " + Math.round(Math.pow(2, playerCount(d.properties.NAME_TAG, rangeValue)) - 1));
                    d3.select(this).attr("class", "county hover");
                })
                .on("mouseout", function(d) {
                    d3.select("body").selectAll("h2").text("");
                    d3.select(this).attr("class", "county");
                });


            d3.select("#timeslide").on("input", function() {
            update(+this.value);
            });

            // update the fill of each SVG of class "incident" with value
            function update(value) {
                document.getElementById("range").innerHTML= period[value][0] + " - " + period[value][1];
                rangeValue = period[value];
                console.log(rangeValue)
                d3.selectAll(".county")
                    .attr("fill", function(d) {
                            // return jenks(whatCounty(d.properties.NAME_TAG)/1);
                            // console.log(playerCount(d.properties.NAME_TAG, rangeValue)/1)
                            if (buttonSetOne == "All Time")
                                return jenks(playerCount(d.properties.NAME_TAG, rangeValue)/1);
                            else if (buttonSetOne == "Player Debut")
                                return  jenkers(divisions)(playerCount(d.properties.NAME_TAG, rangeValue)/1);

                        });
            }

            d3.select("#player-debut").on("click", function() {
                divisions = 5; 
                buttonUpdate(this.value);
                console.log("divisions "+divisions)
                // console.log(buttonSetOne);
            });

            d3.select("#all-time").on("click", function() {
                buttonUpdate(this.value);
                console.log("divisions "+divisions)
                // console.log(buttonSetOne);
            });


            function buttonUpdate(value){
                buttonSetOne = value;
                d3.selectAll(".county")
                    .attr("fill", function(d) {
                            if (buttonSetOne == "All Time")
                                return jenks(playerCount(d.properties.NAME_TAG, rangeValue)/1);
                            else if (buttonSetOne == "Player Debut")
                                return  jenkers(divisions)(playerCount(d.properties.NAME_TAG, rangeValue)/1);
                        });
            }


        }
    });

    
  </script>
</body>
</html>

